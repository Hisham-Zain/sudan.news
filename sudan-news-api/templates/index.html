{% extends "base.html" %}

{% block title %}ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑŸÖÿ¨ŸÖÿπÿ©{% endblock %}

{% block styles %}
<style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
        color: #333;
        line-height: 1.6;
    }

    .header {
        background-color: white;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: center;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .search-bar {
        flex: 1;
        max-width: 400px;
        margin: 0 20px;
        position: relative;
    }

    .search-bar input {
        width: 100%;
        padding: 10px 40px 10px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        background-color: #f8f9fa;
        font-size: 16px;
    }

    .search-bar .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
    }

    .city-filter {
        margin: 0 10px;
    }

    .city-filter select {
        padding: 10px 30px 10px 15px;
        border: 1px solid #ddd;
        border-radius: 25px;
        background-color: #f8f9fa;
        font-size: 14px;
        outline: none;
        cursor: pointer;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
    }

    .app-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
    }

    .hamburger {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
    }

    .category-nav {
        background-color: white;
        padding: 10px 20px;
        border-bottom: 1px solid #e9ecef;
        overflow-x: auto;
        white-space: nowrap;
    }

    .category-tags {
        display: flex;
        gap: 10px;
    }

    .category-tag {
        background-color: #f8f9fa;
        color: #666;
        padding: 8px 16px;
        border-radius: 20px;
        text-decoration: none;
        font-size: 14px;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .category-tag.active,
    .category-tag:hover {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }

    .main-layout {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        gap: 20px;
    }

    .main-content {
        flex: 1;
        min-width: 0;
    }

    .sidebar {
        width: 300px;
    }

    .hero-article {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .hero-article a {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .hero-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }

    .hero-content {
        padding: 20px;
    }

    .hero-title {
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 10px 0;
        color: #333;
    }

    .hero-meta {
        display: flex;
        gap: 15px;
        color: #666;
        font-size: 14px;
    }

    #news-feed {
        display: grid;
        gap: 15px;
    }

    .news-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-decoration: none;
        color: inherit;
        display: block;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .news-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .news-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .news-content {
        padding: 15px;
    }

    .news-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: #333;
    }

    .news-meta {
        display: flex;
        justify-content: space-between;
        color: #666;
        font-size: 13px;
    }

    .sidebar-section {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .sidebar-title {
        font-size: 16px;
        font-weight: bold;
        margin: 0 0 15px 0;
        color: #333;
    }

    .sidebar-item {
        padding: 10px 0;
        border-bottom: 1px solid #f8f9fa;
        text-decoration: none;
        color: inherit;
        display: block;
        transition: color 0.2s;
    }

    .sidebar-item:hover {
        color: #28a745;
    }

    .sidebar-item:last-child {
        border-bottom: none;
    }

    .category-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .category-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .trending-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background-color: #fff3cd;
        color: #856404;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .bias-bar-compact {
        height: 4px;
        background-color: #f0f0f0;
        border-radius: 2px;
        overflow: hidden;
        display: flex;
        margin: 8px 0;
    }

    .bias-segment-compact {
        height: 100%;
        transition: width 0.3s ease;
    }

    .segment-pro {
        background-color: #007bff;
    }

    .segment-neutral {
        background-color: #6c757d;
    }

    .segment-oppose {
        background-color: #dc3545;
    }

    /* Source Badges - NEW */
    .source-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin: 8px 0;
        font-size: 11px;
    }

    .source-badge {
        padding: 2px 6px;
        border-radius: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .pro-badge {
        background-color: #e7f3ff;
        color: #0066cc;
        border: 1px solid #b3e0ff;
    }

    .oppose-badge {
        background-color: #ffe7e7;
        color: #cc0000;
        border: 1px solid #ffb3b3;
    }

    .neutral-badge {
        background-color: #f0f0f0;
        color: #666;
        border: 1px solid #ddd;
    }

    .source-count {
        background-color: #e9ecef;
        color: #666;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 11px;
    }

    .badge-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
    }

    .pro-dot { background-color: #007bff; }
    .neutral-dot { background-color: #6c757d; }
    .oppose-dot { background-color: #dc3545; }

    /* Onboarding Modal Styles */
    .onboarding-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .onboarding-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    .onboarding-modal {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        direction: ltr;
    }

    .onboarding-screen {
        display: none;
        padding: 40px 30px;
        text-align: center;
        min-height: 400px;
    }

    .onboarding-screen.active {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .onboarding-screen h1 {
        font-size: 32px;
        font-weight: bold;
        margin: 0 0 16px 0;
        color: #333;
    }

    .onboarding-screen p {
        font-size: 18px;
        color: #666;
        margin: 0 0 20px 0;
        line-height: 1.5;
    }

    .onboarding-footer {
        font-size: 14px;
        color: #999;
        margin: 20px 0 0 0;
    }

    .bias-preview {
        display: flex;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
        justify-content: center;
    }

    .bias-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
    }

    .bias-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }

    .bias-dot.pro-saf { background-color: #007bff; }
    .bias-dot.anti-saf { background-color: #dc3545; }
    .bias-dot.neutral { background-color: #6c757d; }

    .onboarding-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-skip {
        background: transparent;
        color: #666;
        border: 1px solid #ddd;
    }

    .btn-skip:hover {
        background: #f8f9fa;
    }

    .btn-next {
        background: #28a745;
        color: white;
    }

    .btn-next:hover {
        background: #218838;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: transparent;
        color: #666;
        border: 1px solid #ddd;
    }

    .btn-secondary:hover {
        background: #f8f9fa;
    }

    .methodology-link {
        color: #007bff;
        text-decoration: none;
        font-size: 16px;
    }

    .methodology-link:hover {
        text-decoration: underline;
    }

    .progress-dots {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
    }

    .progress-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ddd;
        transition: background 0.3s ease;
    }

    .progress-dot.active {
        background: #28a745;
    }

    @media (max-width: 768px) {
        .main-layout {
            flex-direction: column;
            padding: 10px;
        }

        .sidebar {
            width: 100%;
        }

        .hero-image {
            height: 200px;
        }

        .header {
            flex-wrap: wrap;
        }

        .search-bar {
            order: 3;
            flex-basis: 100%;
            margin: 10px 0 0 0;
        }

        .city-filter {
            order: 2;
            flex-basis: 100%;
            margin: 10px 0 0 0;
        }

        .onboarding-modal {
            width: 95%;
            padding: 20px;
        }

        .onboarding-screen {
            padding: 30px 20px;
        }

        .onboarding-screen h1 {
            font-size: 28px;
        }

        .onboarding-screen p {
            font-size: 16px;
        }

        .onboarding-buttons {
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            width: 100%;
            max-width: 200px;
        }
    }
</style>
{% endblock %}

{% block header %}
<header class="header">
    <div class="header-actions">
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='img/logo_animate.svg') }}" alt="App Icon" class="app-icon">
        </a>
        <button class="hamburger">‚ò∞</button>
    </div>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ£ÿÆÿ®ÿßÿ±...">
        <span class="search-icon">üîç</span>
    </div>
    <div class="city-filter">
        <select id="city-select">
            <option value="">ŸÉŸÑ ÿßŸÑŸÖÿØŸÜ</option>
            {% if all_cities %}
            {% for city in all_cities %}
            <option value="{{ city }}" {% if current_city==city %}selected{% endif %}>{{ city }}</option>
            {% endfor %}
            {% endif %}
        </select>
    </div>
</header>
{% endblock %}

{% block nav %}
<nav class="category-nav">
    <div class="category-tags" id="category-tags">
        <a href="#" class="category-tag active" data-category="all">ÿßŸÑŸÉŸÑ</a>
    </div>
</nav>
{% endblock %}

{% block content %}
<main class="main-layout">
    <div class="main-content">
        {% if clusters %}
        <article class="hero-article">
            <a href="{{ url_for('event', cluster_id=clusters[0].id) }}">
                {% if clusters[0].first_article and clusters[0].first_article.image_url %}
                <img src="{{ clusters[0].first_article.image_url }}" alt="{{ clusters[0].title }}"
                    class="hero-image" onerror="this.style.display='none'">
                {% endif %}
                <div class="hero-content">
                    <h1 class="hero-title">{{ clusters[0].title }}</h1>
                    <div class="hero-meta">
                        <span>ÿπÿØÿØ ÿßŸÑŸÖÿµÿßÿØÿ±: {{ clusters[0].number_of_sources }}</span>
                        <span>{{ clusters[0].published_at | timeago_arabic }}</span>
                    </div>
                </div>
            </a>
        </article>
        {% endif %}

        <div id="news-feed">
            {% for cluster in clusters[1:] %}
            <a href="{{ url_for('event', cluster_id=cluster.id) }}" class="news-card">
                {% if cluster.image_url %}
                <img src="{{ cluster.image_url }}" alt="{{ cluster.title }}" class="news-image"
                    onerror="this.style.display='none'">
                {% endif %}
                <div class="news-content">
                    {% if cluster.is_trending %}
                    <div class="trending-badge">üî• ÿ±ÿßÿ¶ÿ¨</div>
                    {% endif %}
                    <h3 class="news-title">{{ cluster.title }}</h3>

                    {% if cluster.bias_distribution %}
                    {% set pro = cluster.bias_distribution.pro_saf.percentage %}
                    {% set neutral = cluster.bias_distribution.neutral.percentage %}
                    {% set oppose = cluster.bias_distribution.oppose_saf.percentage %}

                    <div class="bias-bar-compact">
                        {% if pro > 0 %}
                        <div class="bias-segment-compact segment-pro" style="width: {{ pro }}%"
                            title="ŸÖÿ§ŸäÿØ ŸÑŸÑŸÇŸàÿßÿ™ ÿßŸÑŸÖÿ≥ŸÑÿ≠ÿ©: {{ pro|round|int }}%"></div>
                        {% endif %}
                        {% if neutral > 0 %}
                        <div class="bias-segment-compact segment-neutral" style="width: {{ neutral }}%"
                            title="ŸÖÿ≠ÿßŸäÿØ: {{ neutral|round|int }}%"></div>
                        {% endif %}
                        {% if oppose > 0 %}
                        <div class="bias-segment-compact segment-oppose" style="width: {{ oppose }}%"
                            title="ŸÖÿπÿßÿ±ÿ∂ ŸÑŸÑŸÇŸàÿßÿ™ ÿßŸÑŸÖÿ≥ŸÑÿ≠ÿ©: {{ oppose|round|int }}%"></div>
                        {% endif %}
                    </div>

                    {% set biases = [('ŸÖÿ§ŸäÿØ', pro), ('ŸÖÿ≠ÿßŸäÿØ', neutral), ('ŸÖÿπÿßÿ±ÿ∂', oppose)] %}
                    {% set max_bias = biases | max(attribute=1) %}

                    <div style="font-size: 12px; color: #666; margin-top: 4px; margin-bottom: 8px;">
                        {{ max_bias[1]|round|int }}% ÿ™ÿ∫ÿ∑Ÿäÿ© {{ max_bias[0] }}
                    </div>
                    {% endif %}

                    <div class="news-meta">
                        <span>ÿπÿØÿØ ÿßŸÑŸÖÿµÿßÿØÿ±: {{ cluster.number_of_sources }}</span>
                        <span>{{ cluster.published_at | timeago_arabic }}</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        <div id="loading" class="loading" style="display: none;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>

    <aside class="sidebar">
        {% if war_clusters %}
        <section class="sidebar-section" style="border-right: 4px solid #dc3545;">
            <h3 class="sidebar-title" style="color: #dc3545;">ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑÿ≠ÿ±ÿ®</h3>
            {% for cluster in war_clusters %}
            <a href="{{ url_for('event', cluster_id=cluster.id) }}" class="sidebar-item">
                {{ cluster.title[:60] }}...
            </a>
            {% endfor %}
        </section>
        {% endif %}

        {% if trending_clusters %}
        <section class="sidebar-section" style="border-right: 4px solid #ffc107;">
            <h3 class="sidebar-title" style="color: #d39e00;">üî• ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ±Ÿàÿßÿ¨ÿßŸã</h3>
            {% for cluster in trending_clusters %}
            <a href="{{ url_for('event', cluster_id=cluster.id) }}" class="sidebar-item">
                {{ cluster.title[:60] }}...
            </a>
            {% endfor %}
        </section>
        {% endif %}

        <section class="sidebar-section">
            <h3 class="sidebar-title">ÿ¢ÿÆÿ± ÿßŸÑÿ£ÿÆÿ®ÿßÿ±</h3>
            {% for cluster in clusters[:5] %}
            <a href="{{ url_for('event', cluster_id=cluster.id) }}" class="sidebar-item">
                {{ cluster.title[:50] }}...
            </a>
            {% endfor %}
        </section>

        <section class="sidebar-section">
            <h3 class="sidebar-title">ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</h3>
            <div id="sidebar-categories"></div>
        </section>
    </aside>
</main>

<!-- Onboarding Modal -->
<div id="onboarding-overlay" class="onboarding-overlay">
    <div class="onboarding-modal">
        <!-- Screen 1: Welcome -->
        <div id="screen-1" class="onboarding-screen active">
            <h1>Sudanese.news</h1>
            <p>Your window into how different outlets report the war in Sudan.</p>
            <div class="onboarding-footer">Unbiased. Organized. Transparent.</div>
            <div class="onboarding-buttons">
                <button class="btn btn-skip" onclick="skipOnboarding()">Skip</button>
                <button class="btn btn-next" onclick="nextScreen()">Next</button>
            </div>
        </div>

        <!-- Screen 2: What We Do -->
        <div id="screen-2" class="onboarding-screen">
            <h1>See Every Side of the Story</h1>
            <p>We collect news from local and international sources and show how each outlet positions itself in the conflict.</p>
            <div class="bias-preview">
                <div class="bias-item">
                    <div class="bias-dot pro-saf"></div>
                    <span>Pro-SAF</span>
                </div>
                <div class="bias-item">
                    <div class="bias-dot anti-saf"></div>
                    <span>Anti-SAF</span>
                </div>
                <div class="bias-item">
                    <div class="bias-dot neutral"></div>
                    <span>Neutral</span>
                </div>
            </div>
            <div class="onboarding-buttons">
                <button class="btn btn-skip" onclick="skipOnboarding()">Skip</button>
                <button class="btn btn-next" onclick="nextScreen()">Next</button>
            </div>
        </div>

        <!-- Screen 3: Compare Coverage -->
        <div id="screen-3" class="onboarding-screen">
            <h1>One Event, Multiple Narratives</h1>
            <p>Articles about the same incident are grouped together so you can compare how different outlets report it.</p>
            <div class="onboarding-footer">Discover patterns, differences, and hidden angles.</div>
            <div class="onboarding-buttons">
                <button class="btn btn-skip" onclick="skipOnboarding()">Skip</button>
                <button class="btn btn-next" onclick="nextScreen()">Next</button>
            </div>
        </div>

        <!-- Screen 4: Smart Analysis -->
        <div id="screen-4" class="onboarding-screen">
            <h1>Clear, Fast Summaries</h1>
            <p>Every article includes a short AI-assisted summary to help you quickly understand the story.</p>
            <a href="#" class="methodology-link">Learn about our methodology ‚Üí</a>
            <div class="onboarding-buttons">
                <button class="btn btn-skip" onclick="skipOnboarding()">Skip</button>
                <button class="btn btn-next" onclick="nextScreen()">Next</button>
            </div>
        </div>

        <!-- Screen 5: Your News Starts Here -->
        <div id="screen-5" class="onboarding-screen">
            <h1>Stay Informed. Stay Aware.</h1>
            <p>Read articles directly inside the app, search, filter by source, and explore detailed bias tagging.</p>
            <div class="onboarding-buttons">
                <button class="btn btn-primary" onclick="startReading()">Start Reading</button>
                <button class="btn btn-secondary" onclick="skipOnboarding()">Skip</button>
            </div>
        </div>

        <!-- Progress Dots -->
        <div class="progress-dots">
            <div class="progress-dot active" data-screen="1"></div>
            <div class="progress-dot" data-screen="2"></div>
            <div class="progress-dot" data-screen="3"></div>
            <div class="progress-dot" data-screen="4"></div>
            <div class="progress-dot" data-screen="5"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 2;
    let isLoading = false;
    let currentCategory = 'all';
    let currentQuery = '';
    let currentCity = '{{ current_city if current_city else "" }}';

    document.addEventListener('DOMContentLoaded', loadCategories);

    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000 && !isLoading) {
            loadMoreNews();
        }
    });

    document.getElementById('search-input').addEventListener('input', debounce((e) => {
        currentQuery = e.target.value;
        reloadFeed();
    }, 500));

    document.getElementById('city-select').addEventListener('change', (e) => {
        currentCity = e.target.value;
        reloadFeed();
    });

    function loadCategories() {
        fetch('/api/categories')
            .then(response => response.json())
            .then(categories => {
                const categoryTags = document.getElementById('category-tags');
                const sidebarCategories = document.getElementById('sidebar-categories');
                const colors = ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#fd7e14'];

                categories.forEach((category, index) => {
                    const navTag = document.createElement('a');
                    navTag.href = '#';
                    navTag.className = 'category-tag';
                    navTag.dataset.category = category;
                    navTag.textContent = category;
                    categoryTags.appendChild(navTag);

                    const sidebarItem = document.createElement('div');
                    sidebarItem.className = 'category-item';
                    sidebarItem.innerHTML = `
                        <div class="category-indicator" style="background-color: ${colors[index % colors.length]};"></div>
                        <span>${category}</span>
                    `;
                    sidebarCategories.appendChild(sidebarItem);
                });

                document.querySelectorAll('.category-tag').forEach(tag => {
                    tag.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
                        tag.classList.add('active');
                        currentCategory = tag.dataset.category;
                        reloadFeed();
                    });
                });
            })
            .catch(error => console.error('Error loading categories:', error));
    }

    function loadMoreNews() {
        if (isLoading) return;
        isLoading = true;
        document.getElementById('loading').style.display = 'block';

        let url = `/api/clusters?page=${currentPage}&q=${encodeURIComponent(currentQuery)}`;
        if (currentCategory !== 'all') {
            url += `&category=${encodeURIComponent(currentCategory)}`;
        }
        if (currentCity) {
            url += `&city=${encodeURIComponent(currentCity)}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const feed = document.getElementById('news-feed');
                    data.forEach(cluster => {
                        const card = createNewsCard(cluster);
                        feed.appendChild(card);
                    });
                    currentPage++;
                }
            })
            .catch(error => console.error('Error loading more news:', error))
            .finally(() => {
                isLoading = false;
                document.getElementById('loading').style.display = 'none';
            });
    }

    function reloadFeed() {
        currentPage = 1;
        document.getElementById('news-feed').innerHTML = '';
        loadMoreNews();
    }

    function createNewsCard(cluster) {
        const card = document.createElement('a');
        card.href = `/event/${cluster.id}`;
        card.className = 'news-card';

        const imageHtml = cluster.image_url ?
            `<img src="${cluster.image_url}" alt="${cluster.title}" class="news-image" onerror="this.style.display='none'">` : '';

        const trendingHtml = cluster.is_trending ?
            '<div class="trending-badge">üî• ÿ±ÿßÿ¶ÿ¨</div>' : '';

        let biasBarHtml = '';
        let coverageTextHtml = '';
        let sourceBadgesHtml = '';

        if (cluster.bias_distribution) {
            const pro = cluster.bias_distribution.pro_saf.percentage;
            const neutral = cluster.bias_distribution.neutral.percentage;
            const oppose = cluster.bias_distribution.oppose_saf.percentage;

            biasBarHtml = '<div class="bias-bar-compact">';
            if (pro > 0) {
                biasBarHtml += `<div class="bias-segment-compact segment-pro" style="width: ${pro}%" title="ŸÖÿ§ŸäÿØ ŸÑŸÑŸÇŸàÿßÿ™ ÿßŸÑŸÖÿ≥ŸÑÿ≠ÿ©: ${Math.round(pro)}%"></div>`;
            }
            if (neutral > 0) {
                biasBarHtml += `<div class="bias-segment-compact segment-neutral" style="width: ${neutral}%" title="ŸÖÿ≠ÿßŸäÿØ: ${Math.round(neutral)}%"></div>`;
            }
            if (oppose > 0) {
                biasBarHtml += `<div class="bias-segment-compact segment-oppose" style="width: ${oppose}%" title="ŸÖÿπÿßÿ±ÿ∂ ŸÑŸÑŸÇŸàÿßÿ™ ÿßŸÑŸÖÿ≥ŸÑÿ≠ÿ©: ${Math.round(oppose)}%"></div>`;
            }
            biasBarHtml += '</div>';

            const biases = [
                { label: 'ŸÖÿ§ŸäÿØ', value: pro },
                { label: 'ŸÖÿ≠ÿßŸäÿØ', value: neutral },
                { label: 'ŸÖÿπÿßÿ±ÿ∂', value: oppose }
            ];
            biases.sort((a, b) => b.value - a.value);
            const maxBias = biases[0];

            coverageTextHtml = `
                <div style="font-size: 12px; color: #666; margin-top: 4px; margin-bottom: 8px;">
                    ${Math.round(maxBias.value)}% ÿ™ÿ∫ÿ∑Ÿäÿ© ${maxBias.label}
                </div>
            `;
        }

        // NEW: Generate source badges HTML
        if (cluster.articles && cluster.articles.length > 0) {
            const sourcesToShow = cluster.articles.slice(0, 3); // Show up to 3 sources
            const remainingSources = cluster.number_of_sources - sourcesToShow.length;

            sourceBadgesHtml = '<div class="source-badges">';

            sourcesToShow.forEach(article => {
                // Use the actual data structure from cluster repository
                const sourceName = article.source_name || article.source_url || 'ŸÖÿµÿØÿ± ŸÖÿ¨ŸáŸàŸÑ';
                const sourceBias = article.source_bias;

                if (sourceBias) {
                    const biasClass = sourceBias === 'Pro-SAF' ? 'pro-badge' :
                                     sourceBias === 'Oppose-SAF' ? 'oppose-badge' : 'neutral-badge';
                    const dotClass = sourceBias === 'Pro-SAF' ? 'pro-dot' :
                                    sourceBias === 'Oppose-SAF' ? 'oppose-dot' : 'neutral-dot';
                    const biasLabel = sourceBias === 'Pro-SAF' ? 'ŸÖÿ§ŸäÿØ' :
                                    sourceBias === 'Oppose-SAF' ? 'ŸÖÿπÿßÿ±ÿ∂' : 'ŸÖÿ≠ÿßŸäÿØ';

                    sourceBadgesHtml += `
                        <span class="source-badge ${biasClass}" title="${sourceName} - ${biasLabel}">
                            <span class="badge-dot ${dotClass}"></span>
                            ${sourceName.substring(0, 15)}
                        </span>
                    `;
                }
            });

            if (remainingSources > 0) {
                sourceBadgesHtml += `<span class="source-count">+${remainingSources}</span>`;
            }

            sourceBadgesHtml += '</div>';
        }

        card.innerHTML = `
            ${imageHtml}
            <div class="news-content">
                ${trendingHtml}
                <h3 class="news-title">${cluster.headline}</h3>
                ${biasBarHtml}
                ${coverageTextHtml}
                ${sourceBadgesHtml}
                <div class="news-meta">
                    <span>ÿπÿØÿØ ÿßŸÑŸÖÿµÿßÿØÿ±: ${cluster.number_of_sources}</span>
                    <span>${timeAgoArabic(cluster.first_date_of_publication)}</span>
                </div>
            </div>
        `;

        return card;
    }

    function timeAgoArabic(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        let interval = seconds / 31536000;
        if (interval > 1) return 'ŸÖŸÜÿ∞ ' + Math.floor(interval) + ' ÿ≥ŸÜÿ©';
        interval = seconds / 2592000;
        if (interval > 1) return 'ŸÖŸÜÿ∞ ' + Math.floor(interval) + ' ÿ¥Ÿáÿ±';
        interval = seconds / 86400;
        if (interval > 1) return 'ŸÖŸÜÿ∞ ' + Math.floor(interval) + ' ŸäŸàŸÖ';
        interval = seconds / 3600;
        if (interval > 1) return 'ŸÖŸÜÿ∞ ' + Math.floor(interval) + ' ÿ≥ÿßÿπÿ©';
        interval = seconds / 60;
        if (interval > 1) return 'ŸÖŸÜÿ∞ ' + Math.floor(interval) + ' ÿØŸÇŸäŸÇÿ©';
        return 'ŸÖŸÜÿ∞ ŸÑÿ≠ÿ∏ÿßÿ™';
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Onboarding functionality
    let currentScreen = 1;
    const totalScreens = 5;

    document.addEventListener('DOMContentLoaded', function() {
        // Show onboarding on page load
        showOnboarding();

        // Load categories as before
        loadCategories();
    });

    function showOnboarding() {
        const overlay = document.getElementById('onboarding-overlay');
        overlay.classList.add('show');
    }

    function hideOnboarding() {
        const overlay = document.getElementById('onboarding-overlay');
        overlay.classList.remove('show');
    }

    function nextScreen() {
        if (currentScreen < totalScreens) {
            showScreen(currentScreen + 1);
        }
    }

    function skipOnboarding() {
        hideOnboarding();
    }

    function startReading() {
        hideOnboarding();
    }

    function showScreen(screenNumber) {
        // Hide all screens
        document.querySelectorAll('.onboarding-screen').forEach(screen => {
            screen.classList.remove('active');
        });

        // Show the target screen
        const targetScreen = document.getElementById(`screen-${screenNumber}`);
        if (targetScreen) {
            targetScreen.classList.add('active');
            currentScreen = screenNumber;
            updateProgressDots();
        }
    }

    function updateProgressDots() {
        document.querySelectorAll('.progress-dot').forEach((dot, index) => {
            if (index + 1 === currentScreen) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    }
</script>
{% endblock %}
